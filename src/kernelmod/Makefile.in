
KERNELPATH=@KERNELPATH@
SRCDIR=@srcdir@
TOP_SRCDIR=@top_srcdir@
BUILDDIR=@builddir@

ifndef KERNELPATH
	KERNELPATH := /lib/modules/$(shell uname -r)/build
endif

obj-m := spin.o
spin-objs := spin_kmod.o \
             messaging.o \
             pkt_info.o \
             pkt_info_list.o \
             spin_util.o \
             spin_cfg.o \
             spin_traffic_send_thread.o

all: prepare module

# There seems to be no way to build out-of-tree, so copy-if-updated
# all kernel module source files, if we are building in a different
# directory
prepare:
ifneq ($(SRCDIR),$(BUILDDIR))
	@cp -u $(SRCDIR)/*.c ./
	@cp -u $(SRCDIR)/*.h ./
	@cp -u $(TOP_SRCDIR)/include/pkt_info.h ./
	@cp -u $(TOP_SRCDIR)/include/spin_cfg.h ./
endif

module:
	$(MAKE) -I$(SRCDIR) -I$(TOP_SRCDIR)/include -C $(KERNELPATH) M=$(PWD) -I../src modules

distclean: clean
ifneq ($(SRCDIR),$(BUILDDIR))
	rm *.c
	rm *.h
endif

clean:
	rm -rf *.o *.ko *.mod.* *.cmd .module* modules* Module* .*.cmd .tmp*
	make -C $(KERNELPATH) M=$(PWD) -I$(SRCDIR) clean
